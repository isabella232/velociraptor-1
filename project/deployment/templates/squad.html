{% extends 'base.html' %}
{% load static from staticfiles %}

{% block content %}
<div class="row-fluid">
<div class="span12">
    {% if squad.id %}
    <h1>Squad: {{ squad }}</h1>
    {% else %}
    <h1>New Squad</h1>
    {% endif %}
</div>
</div>

<div class="row-fluid">
<div class="span4">

    <form method='post' class='well raptorform'{% if enctype %} enctype="{{ enctype }}"{% endif %}>{% csrf_token %}
        {{ form.non_field_errors }}
        {% if instructions %}
          {# No, we dont' have to close that <p> tag.  This is HTML5 baby! #}
          <p>{{ instructions }}
        {% endif %}
    <table class="formrows">
      {{ form.as_table }}
      <tr><td colspan=2 class="buttoncell">
    <button type="submit" class="btn btn-primary">{% if btn_text %}
        {{ btn_text }}{% else %}Submit{% endif %}</button>
    </td></tr>
    </table>
    </form>
    {% if docstring %}<p class="docstring"> {{ docstring }}{% endif %}
    {# only show add host button if the squad is savede #}
    {% if squad.id %}
    <div>
      {# TODO: Use a dialog on this page for adding hosts instead of linking to admin #}
        <!--<button id="btn-add-host" type="button" class="btn btn-inverse btn-mini">Add Host</button>-->
        <a href="/admin/deployment/squad/{{ squad.id }}/">Add Host</a>
    </div>
    {% endif %}
</div>

{# Only show host list if it's not a new squad #}
{% if squad.id %}
<div class="span8 hostgrid">
    <h2>Hosts</h2>
    <div class="row-fluid">
        {# now a block for each host #}
        {% for host in squad.hosts.all %}
        <div class="span4 hostblock" data-hostname="{{host.name}}"><h4>{{ host.name }}</h4>
        <div class="procgrid">
            <img src="{% static 'img/waiting.gif' %}">
        </div>
        </div>
        {% endfor %}
    </div>
</div>
</div>{# endrow #}
{% endif %}
{% endblock content %}

{% block script %}
{# TODO: Make this template and accompanying JS global #}
<script id="proc-details-tmpl" type="text/goatee">

    <div class="modal task-details">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>
        <h3><%name%> </h3>
        on <a href="http://<%host%>:<%port%>"><%host%>:<%port%></a>
    </div>
    <div class="modal-body">
        <table class="attrs">
            <tr><th class="rowlabel">Name</th><td><%name%></td></tr>
            <tr><th class="rowlabel">Description</th><td><%description%></td></tr>
            <tr><th class="rowlabel">State</th><td><%statename%></td></tr>
            <tr><th class="rowlabel">App</th><td><%app%></td></tr>
            <tr><th class="rowlabel">Tag</th><td><%tag%></td></tr>
            <tr><th class="rowlabel">Config Recipe</th><td><%recipe%></td></tr>
            <tr><th class="rowlabel">Release Hash</th><td><%hash%></td></tr>
            <tr><th class="rowlabel">Proc Name</th><td><%proc%></td></tr>
            <tr><th class="rowlabel">Host</th><td><%host%></td></tr>
            <tr><th class="rowlabel">Port</th><td><%port%></td></tr>
        </table>
    </div>

    </div>

</script>

{# the box for each host #}
<script id="proc-block-tmpl" type="text/goatee">
    <div class="span4"><h4><%host%></h4>
    </div>
</script>

{# the inner grid of proc data for each host #}
<script id="procgrid-tmpl" type="text/goatee">
    <div class="procgrid">
        <%#states%>
        <div class="procbox <%statename%>" id="proc-<%id%>"></div>
        <%/states%>
    </div>
</script>

{# the Add Host dialog #}
<script id="add-host-tmpl" type="text/goatee">
<div class="modal task-details">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>
        <h3>Add Host</h3>
    </div>
    <div class="modal-body">
        <form id="frm-add-host">
        <table class="attrs">
            <tr><th class="rowlabel">Hostname</th><td><input type="text"
                    name="hostname" id="input-hostname"></td></tr>
        </table>
        </form>
    </div>
</div>
</script>

<script>
    var render_procs = function(hostblock, hostdata) {
        // add a clean ID for each proc obj
        _.each(hostdata.states, function(el) {
          el.id = el.name.replace(/\./g, "");
        });
        var grid = $(hostblock).children('.procgrid');
        grid.html($('#procgrid-tmpl').goatee(hostdata));
        {# bind data to the children #}
        _.each(hostdata.states, function(el) {
            var procbox = $(hostblock).find('#proc-' + el.id);
            procbox.data(el);
        });
    };

    $(function() {
        {# delegate the modal launcher for each colored procbox #}
        $('body').delegate('.procbox', 'click', function() {
            $('#proc-details-tmpl').goatee($(this).data()).modal();
        });

        {# bind the Add Host handler #}
        $('#btn-add-host').click(function() {
            $('#add-host-tmpl').goatee().modal();
        });

        _.each($('.hostgrid .hostblock'), function(block) {
            var hostname = $(block).data('hostname');
            // do an ajax request to get the states
            $.getJSON('/api/hosts/' + hostname + '/procs/', function(data, sts,
            xhr) {
                render_procs(block, data);
            });
        });
    });
</script>
{% endblock script %}
